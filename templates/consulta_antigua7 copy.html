{% extends 'layout.html' %}

{% block title %}Consulta{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-center my-5">¡Hablemos!</h1>
  <div class="row">
    <div class="col-md-8">
      <div class="chat-container">
        <div class="chat-area">
          
        </div>
        <form method="POST">
          <div class="input-group mb-3">
            <input type="text" class="form-control" name="question" placeholder="Escribe aquí tu mensaje" aria-label="Escribe aquí tu mensaje" aria-describedby="button-addon2">
            <button class="btn btn-primary" type="submit" id="button-addon2"><i class="fas fa-paper-plane"></i></button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-md-4">
      <div class="voice-panel">
        <button id="voice-btn" class="btn btn-primary"><i class="fas fa-microphone"></i></button>
        <select class="form-select my-2" id="language-select">
          <option value="es-ES" selected>Español</option>
          <option value="en-US">Inglés</option>
        </select>
      </div>
      <div class="chat-history-panel">
        <h5>Historial de conversación:</h5>
        <div class="audio-btn-container">
          {% if audio %}
            <button class="btn btn-primary" data-audio="{{ audio }}"><i class="fas fa-volume-up"></i></button>          
          {% endif %}
        </div>
        <div class="chat-history">
          {% for message in chat %}
            {% if message['speaker'] == 'user' %}
              <div class="message">{{ message['text'] }}</div>
            {% elif message['speaker'] == 'bot' %}
              <div class="message text-end">{{ message['text'] }}</div>
              {% if message['audio'] %}
                <audio class="answer-audio" controls>
                  <source src="{{ message['audio'] }}" type="audio/mpeg">
                </audio>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="message text-end">{{ answer }}</div>


<script>
  const speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new speechRecognition();
  const voiceBtn = document.getElementById('voice-btn');
  const languageSelect = document.getElementById('language-select');
  const chatArea = document.querySelector('.chat-area');
  const chat = {{ chat|tojson }};
  

  recognition.lang = languageSelect.value;

  voiceBtn.addEventListener('click', () => {
    recognition.start();
  });

  recognition.addEventListener('result', (event) => {
    const transcript = event.results[0][0].transcript;
    document.querySelector('input[name=question]').value = transcript;
    document.querySelector('form').submit();
  });

  languageSelect.addEventListener('change', () => {
    recognition.lang = languageSelect.value;
  });

  const answerAudios = document.querySelectorAll('.answer-audio');
  answerAudios.forEach((audio) => {
    audio.addEventListener('play', (event) => {
      event.target.onended = () => {
        recognition.start();
      };
    });
  });

  
  const audioButtons = document.querySelectorAll('.audio-btn');
  audioButtons.forEach((button) => {
    button.addEventListener('click', () => {
    const audioSrc = button.getAttribute('data-audio');
    const audio = new Audio(audioSrc);
    audio.play();
  });
});

  function addMessageToChatArea(message) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    if (message.speaker === 'user') {
      messageDiv.textContent = message.text;
    } else {
      const messageText = message.text;
      const messageAudio = message.audio;
      const messageAudioHtml = messageAudio ? `<audio class="answer-audio" src="${messageAudio}"></audio>` : '';
      messageDiv.innerHTML = `<div>${messageText}</div><div>${messageAudioHtml}</div>`;
    }
    chatArea.appendChild(messageDiv);
  }
  
  const historyBtn = document.getElementById('history-btn');
  const historyModal = new bootstrap.Modal(document.getElementById('history-modal'));
  const historyModalBody = document.querySelector('.history-modal-body');

  historyBtn.addEventListener('click', () => {
    historyModalBody.innerHTML = '';
    history.forEach((message) => {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      if (message.speaker === 'user') {
        messageDiv.textContent = message.text;
        messageDiv.classList.add('user-message');
      } else {
        const messageText = message.text;
        const messageAudio = message.audio;
        const messageAudioHtml = messageAudio ? `<audio class="answer-audio" src="${messageAudio}" controls></audio>` : '';
        messageDiv.innerHTML = `<div>${messageText}</div><div>${messageAudioHtml}</div>`;
        messageDiv.classList.add('bot-message');
      }
      historyModalBody.appendChild(messageDiv);
    });
    historyModal.show();
  });
</script>

{% endblock %}