{% extends 'layout.html' %}

{% block title %}Consulta{% endblock %}

{% block content %}

<div class="chat-container">

  <form method="POST">
    <div class="chat-input-container">
      <input type="text" class="chat-input-container" name="question" placeholder="Escribe aquí tu mensaje">
      <button class="btn btn-primary" type="submit" id="button-addon2">Enviar</button>
    </div>
  </form>
  
</div>
<div class="chat-history-container">
  {% for message in chat[::-1] %}
    {% if message['speaker'] == 'user' %}
      <div class="message user">{{ 'Yo: ' + message['text'] }}</div>
    {% elif message['speaker'] == 'bot' %}
      {% if message['audio'] %}
        <audio class="answer-audio" controls>
          <source src="{{ message['audio'] }}" type="audio/mpeg">
        </audio>
      {% endif %}
      <div class="message bot">{{ 'Robot: ' + message['text'] }}</div>
    {% endif %}
  {% endfor %}
</div>


<script>
  const speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new speechRecognition();
  const voiceBtn = document.getElementById('voice-btn');
  const languageSelect = document.getElementById('language-select');
  const chatArea = document.querySelector('.chat-area');
  const chat = {{ chat|tojson }};
  

  recognition.lang = languageSelect.value;

  voiceBtn.addEventListener('click', () => {
    recognition.start();
  });

  recognition.addEventListener('result', (event) => {
    const transcript = event.results[0][0].transcript;
    document.querySelector('input[name=question]').value = transcript;
    document.querySelector('form').submit();
  });

  languageSelect.addEventListener('change', () => {
    recognition.lang = languageSelect.value;
  });

  const answerAudios = document.querySelectorAll('.answer-audio');
  answerAudios.forEach((audio) => {
    audio.addEventListener('play', (event) => {
      event.target.onended = () => {
        recognition.start();
      };
    });
  });

  
  const audioButtons = document.querySelectorAll('.audio-btn');
  audioButtons.forEach((button) => {
    button.addEventListener('click', () => {
    const audioSrc = button.getAttribute('data-audio');
    const audio = new Audio(audioSrc);
    audio.play();
  });
});

  function addMessageToChatArea(message) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    if (message.speaker === 'user') {
      messageDiv.textContent = message.text;
    } else {
      const messageText = message.text;
      const messageAudio = message.audio;
      const messageAudioHtml = messageAudio ? `<audio class="answer-audio" src="${messageAudio}"></audio>` : '';
      messageDiv.innerHTML = `<div>${messageText}</div><div>${messageAudioHtml}</div>`;
    }
    chatArea.appendChild(messageDiv);
  }
  
  const historyBtn = document.getElementById('history-btn');
  const historyModal = new bootstrap.Modal(document.getElementById('history-modal'));
  const historyModalBody = document.querySelector('.history-modal-body');

  historyBtn.addEventListener('click', () => {
    historyModalBody.innerHTML = '';
    history.forEach((message) => {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      if (message.speaker === 'user') {
        messageDiv.textContent = message.text;
        messageDiv.classList.add('user-message');
      } else {
        const messageText = message.text;
        const messageAudio = message.audio;
        const messageAudioHtml = messageAudio ? `<audio class="answer-audio" src="${messageAudio}" controls></audio>` : '';
        messageDiv.innerHTML = `<div>${messageText}</div><div>${messageAudioHtml}</div>`;
        messageDiv.classList.add('bot-message');
      }
      historyModalBody.appendChild(messageDiv);
    });
    historyModal.show();
  });

// Actualizar la lista desplegable con el historial de conversación
function updateChatHistorySelect(chat) {
  const chatHistorySelect = document.querySelector('#chat-history-select');
  chatHistorySelect.innerHTML = '';
  for (let i = chat.length - 1; i >= 0; i--) {
    const message = chat[i];
    const option = document.createElement('option');
    option.value = i;
    option.textContent = message.text;
    chatHistorySelect.appendChild(option);
  }
}

// Desplazarse por el historial de conversación
function navigateChatHistory(chat) {
  const chatHistorySelect = document.querySelector('#chat-history-select');
  const selectedIndex = chatHistorySelect.selectedIndex;
  if (selectedIndex !== -1) {
    const selectedMessage = chat[chat.length - 1 - selectedIndex];
    const questionInput = document.querySelector('input[name=question]');
    questionInput.value = selectedMessage.text;
  }
}

// Actualizar la lista desplegable al cargar la página
document.addEventListener('DOMContentLoaded', function() {
  const chat = {{ chat | tojson }};
  updateChatHistorySelect(chat);
});

// Actualizar la lista desplegable al agregar un nuevo mensaje
document.querySelector('form').addEventListener('submit', function(event) {
  const chat = {{ chat | tojson }};
  updateChatHistorySelect(chat);
});

// Desplazarse por el historial de conversación al cambiar el elemento seleccionado
document.querySelector('#chat-history-select').addEventListener('selectmenuchange', function() {
  const chat = {{ chat | tojson }};
  navigateChatHistory(chat);
});


</script>

{% endblock %}