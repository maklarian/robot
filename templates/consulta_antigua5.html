{% extends 'layout.html' %}

{% block title %}Consulta{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-center my-5">¡Hablemos!</h1>
  <div class="row">
    <div class="col-md-8">
      <div class="chat-container">
        <div class="chat-area">
          {% for message in history %}
            {% if message['speaker'] == 'user' %}
              <div class="message">{{ message['text'] }}</div>
            {% elif message['speaker'] == 'bot' %}
              <div class="message text-end">{{ message['text'] }}</div>
              {% if message['audio'] %}
                <audio class="answer-audio" controls>
                  <source src="{{ message['audio'] }}" type="audio/mpeg">
                </audio>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
        <form method="POST">
          <div class="input-group mb-3">
            <input type="text" class="form-control" name="question" placeholder="Escribe aquí tu mensaje" aria-label="Escribe aquí tu mensaje" aria-describedby="button-addon2">
            <button class="btn btn-primary" type="submit" id="button-addon2"><i class="fas fa-paper-plane"></i></button>
          </div>
        </form>
      </div>
    </div>
    <div class="col-md-4">
      <div class="voice-panel">
        <button id="voice-btn" class="btn btn-primary"><i class="fas fa-microphone"></i></button>
        <select class="form-select my-2" id="language-select">
          <option value="es-ES" selected>Español</option>
          <option value="en-US">Inglés</option>
        </select>
      </div>
    </div>
  </div>
</div>

{% if answer %}
  <div class="message text-end">{{ answer }}</div>
  <audio class="answer-audio" controls>
    <source src="{{ audio }}" type="audio/mpeg">
  </audio>
{% endif %}

<script>
  const speechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new speechRecognition();
  const voiceBtn = document.getElementById('voice-btn');
  const languageSelect = document.getElementById('language-select');
  const chatArea = document.querySelector('.chat-area');

  recognition.lang = languageSelect.value;

  voiceBtn.addEventListener('click', () => {
    recognition.start();
  });

  recognition.addEventListener('result', (event) => {
    const transcript = event.results[0][0].transcript;
    document.querySelector('input[name=question]').value = transcript;
    document.querySelector('form').submit();
  });

  languageSelect.addEventListener('change', () => {
    recognition.lang = languageSelect.value;
  });

  const answerAudios = document.querySelectorAll('.answer-audio');
  answerAudios.forEach((audio) => {
    audio.addEventListener('play', (event) => {
      event.target.onended = () => {
        recognition.start();
      };
    });
  });
</script>

{% endblock %}




